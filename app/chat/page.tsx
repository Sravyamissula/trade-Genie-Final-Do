"use client"

import type React from "react"

import { useState, useEffect, useRef } from "react"
import { motion, AnimatePresence } from "framer-motion"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Card } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Send, Sparkles, FileText, Users, Shield, Mic, Download, Copy, MoreVertical, ArrowLeft, Bot, User, Languages } from 'lucide-react'
import Link from "next/link"
import { useRouter } from "next/navigation"

interface Message {
  id: string
  role: "user" | "assistant"
  content: string
  timestamp: string
  intents?: any
  language?: string
}

interface ChatUser {
  id: number
  firstName: string
  lastName: string
  email: string
}

const LANGUAGES = {
  en: { name: "English", flag: "ЁЯЗ║ЁЯЗ╕" },
  hi: { name: "рд╣рд┐рдВрджреА", flag: "ЁЯЗоЁЯЗ│" },
  te: { name: "р░др▒Жр░▓р▒Бр░Чр▒Б", flag: "ЁЯЗоЁЯЗ│" },
  ta: { name: "родрооро┐ро┤рпН", flag: "ЁЯЗоЁЯЗ│" },
  ml: { name: "р┤ор┤▓р┤пр┤╛р┤│р┤В", flag: "ЁЯЗоЁЯЗ│" },
}

const WELCOME_MESSAGES = {
  en: "Hello there! ЁЯСЛ I'm TradeGenie, your intelligent trade assistant. How can I help you today?",
  hi: "рдирдорд╕реНрддреЗ! ЁЯСЛ рдореИрдВ рдЯреНрд░реЗрдбрдЬреАрдиреА рд╣реВрдВ, рдЖрдкрдХрд╛ рдмреБрджреНрдзрд┐рдорд╛рди рд╡реНрдпрд╛рдкрд╛рд░ рд╕рд╣рд╛рдпрдХред рдЖрдЬ рдореИрдВ рдЖрдкрдХреА рдХреИрд╕реЗ рдорджрдж рдХрд░ рд╕рдХрддрд╛ рд╣реВрдВ?",
  te: "р░╣р░▓р▒Л! ЁЯСЛ р░ир▒Зр░ир▒Б р░Яр▒Нр░░р▒Зр░бр▒НтАМр░Ьр▒Ар░ир▒А, р░ор▒А р░др▒Жр░▓р░┐р░╡р▒Ир░и р░╡р░╛р░гр░┐р░Ьр▒Нр░п р░╕р░╣р░╛р░пр░Хр▒Бр░бр▒Б. р░Ир░░р▒Лр░Ьр▒Б р░ир▒Зр░ир▒Б р░ор▒Ар░Хр▒Б р░Ор░▓р░╛ р░╕р░╣р░╛р░пр░В р░Ър▒Зр░пр░Чр░▓р░ир▒Б?",
  ta: "ро╡рогроХрпНроХроорпН! ЁЯСЛ роиро╛ройрпН роЯро┐ро░рпЗроЯрпНроЬрпАройро┐, роЙроЩрпНроХро│рпН рокрпБродрпНродро┐роЪро╛ро▓ро┐ ро╡ро░рпНродрпНродроХ роЙродро╡ро┐ропро╛ро│ро░рпН. роЗройрпНро▒рпБ роиро╛ройрпН роЙроЩрпНроХро│рпБроХрпНроХрпБ роОрокрпНрокроЯро┐ роЙродро╡ роорпБроЯро┐ропрпБроорпН?",
  ml: "р┤╣р┤▓р╡Л! ЁЯСЛ р┤Юр┤╛р╡╗ р┤Яр╡Нр┤░р╡Зр┤бр╡Нр┤Ьр╡Ар┤ир┤┐ р┤Жр┤гр╡Н, р┤ир┤┐р┤Щр╡Нр┤Щр┤│р╡Бр┤Яр╡Ж р┤мр╡Бр┤жр╡Нр┤зр┤┐р┤ор┤╛р┤ир┤╛р┤п р┤╡р╡Нр┤пр┤╛р┤кр┤╛р┤░ р┤╕р┤╣р┤╛р┤пр┤┐. р┤Зр┤ир╡Нр┤ир╡Н р┤Юр┤╛р╡╗ р┤ир┤┐р┤Щр╡Нр┤Щр┤│р╡Ж р┤Ор┤Щр╡Нр┤Щр┤ир╡Ж р┤╕р┤╣р┤╛р┤пр┤┐р┤Хр╡Нр┤Хр┤╛р┤В?",
}

const PLACEHOLDERS = {
  en: "Ask me anything about global trade, tariffs, documentation, or market opportunities...",
  hi: "рд╡реИрд╢реНрд╡рд┐рдХ рд╡реНрдпрд╛рдкрд╛рд░, рдЯреИрд░рд┐рдл, рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг, рдпрд╛ рдмрд╛рдЬрд╝рд╛рд░ рдХреЗ рдЕрд╡рд╕рд░реЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХреБрдЫ рднреА рдкреВрдЫреЗрдВ...",
  te: "р░Чр▒Нр░▓р▒Лр░мр░▓р▒Н р░Яр▒Нр░░р▒Зр░бр▒Н, р░Яр░╛р░░р░┐р░лр▒НтАМр░▓р▒Б, р░бр░╛р░Хр▒Нр░пр▒Бр░ор▒Жр░Вр░Яр▒Зр░╖р░ир▒Н р░▓р▒Зр░жр░╛ р░ор░╛р░░р▒Нр░Хр▒Жр░Яр▒Н р░Ер░╡р░Хр░╛р░╢р░╛р░▓ р░Чр▒Бр░░р░┐р░Вр░Ър░┐ р░Пр░жр▒Ир░ир░╛ р░Ер░бр░Чр░Вр░бр░┐...",
  ta: "роЙро▓роХро│ро╛ро╡ро┐роп ро╡ро░рпНродрпНродроХроорпН, роХроЯрпНроЯрогроЩрпНроХро│рпН, роЖро╡рогроЩрпНроХро│рпН роЕро▓рпНро▓родрпБ роЪроирпНродрпИ ро╡ро╛ропрпНрокрпНрокрпБроХро│рпН рокро▒рпНро▒ро┐ роОродрпИропрпБроорпН роХрпЗро│рпБроЩрпНроХро│рпН...",
  ml: "р┤Жр┤Чр╡Лр┤│ р┤╡р╡Нр┤пр┤╛р┤кр┤╛р┤░р┤В, р┤др┤╛р┤░р┤┐р┤лр╡Бр┤Хр╡╛, р┤бр╡Лр┤Хр╡Нр┤пр╡Бр┤ор╡Жр┤ир╡Нр┤▒р╡Зр┤╖р╡╗ р┤Ер┤▓р╡Нр┤▓р╡Жр┤Щр╡Нр┤Хр┤┐р╡╜ р┤ор┤╛р╡╝р┤Хр╡Нр┤Хр┤▒р╡Нр┤▒р╡Н р┤Ер┤╡р┤╕р┤░р┤Щр╡Нр┤Щр╡╛ р┤Ор┤ир╡Нр┤ир┤┐р┤╡р┤пр╡Жр┤Хр╡Нр┤Хр╡Бр┤▒р┤┐р┤Ър╡Нр┤Ър╡Н р┤Ор┤ир╡Нр┤др╡Бр┤В р┤Ър╡Лр┤жр┤┐р┤Хр╡Нр┤Хр╡Бр┤Х...",
}

export default function ChatPage() {
  const [messages, setMessages] = useState<Message[]>([])
  const [inputMessage, setInputMessage] = useState("")
  const [isLoading, setIsLoading] = useState(false)
  const [isTyping, setIsTyping] = useState(false)
  const [user, setUser] = useState<ChatUser | null>(null)
  const [chatId, setChatId] = useState<string>("")
  const [selectedLanguage, setSelectedLanguage] = useState<keyof typeof LANGUAGES>("en")
  const messagesEndRef = useRef<HTMLDivElement>(null)
  const router = useRouter()

  useEffect(() => {
    // Get user from localStorage
    const userData = localStorage.getItem("user")
    if (userData) {
      setUser(JSON.parse(userData))
    } else {
      router.push("/auth/signin")
    }

    // Get saved language preference
    const savedLanguage = localStorage.getItem("chatLanguage") as keyof typeof LANGUAGES
    if (savedLanguage && LANGUAGES[savedLanguage]) {
      setSelectedLanguage(savedLanguage)
    }

    // Initialize chat with welcome message in selected language
    const welcomeMessage: Message = {
      id: "welcome",
      role: "assistant",
      content: WELCOME_MESSAGES[savedLanguage || "en"],
      timestamp: new Date().toISOString(),
      language: savedLanguage || "en",
    }

    setMessages([welcomeMessage])
  }, [router])

  useEffect(() => {
    scrollToBottom()
  }, [messages])

  useEffect(() => {
    // Save language preference and update welcome message
    localStorage.setItem("chatLanguage", selectedLanguage)

    // Update welcome message when language changes
    setMessages([
      {
        id: "welcome",
        role: "assistant",
        content: WELCOME_MESSAGES[selectedLanguage],
        timestamp: new Date().toISOString(),
        language: selectedLanguage,
      },
    ])
  }, [selectedLanguage])

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" })
  }

  const sendMessage = async () => {
    if (!inputMessage.trim() || isLoading || !user) return

    const userMessage: Message = {
      id: Date.now().toString(),
      role: "user",
      content: inputMessage,
      timestamp: new Date().toISOString(),
      language: selectedLanguage,
    }

    setMessages((prev) => [...prev, userMessage])
    setInputMessage("")
    setIsLoading(true)
    setIsTyping(true)

    try {
      const response = await fetch("/api/chat", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${localStorage.getItem("token")}`,
        },
        body: JSON.stringify({
          message: inputMessage,
          chatId: chatId || undefined,
          userId: user.id,
          language: selectedLanguage,
        }),
      })

      if (!response.ok) {
        // Handle HTTP errors
        let errorData
        try {
          errorData = await response.json()
        } catch {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`)
        }
        throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`)
      }

      const data = await response.json()

      if (response.ok && data.response) {
        // Simulate typing delay
        setTimeout(() => {
          const aiMessage: Message = {
            id: Date.now().toString(),
            role: "assistant",
            content: data.response,
            timestamp: data.timestamp,
            intents: data.intents,
            language: selectedLanguage,
          }

          setMessages((prev) => [...prev, aiMessage])
          setChatId(data.chatId)
          setIsTyping(false)
        }, 1500)
      } else {
        throw new Error(data.error || "Failed to get response from server")
      }
    } catch (error: any) {
      console.error("Error sending message:", error)
      
      let errorMessage = "I apologize, but I'm experiencing some technical difficulties right now."
      
      // Check if it's a network error
      if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
        errorMessage = "Unable to connect to the server. Please check your internet connection and try again."
      } else if (error.message && error.message.includes('JSON')) {
        errorMessage = "There was a communication error with the server. Please try again in a moment."
      }

      const errorMessages = {
        en: errorMessage,
        hi: "рдореБрдЭреЗ рдЦреЗрдж рд╣реИ, рд▓реЗрдХрд┐рди рдореБрдЭреЗ рдЕрднреА рдХреБрдЫ рддрдХрдиреАрдХреА рдХрдард┐рдирд╛рдЗрдпреЛрдВ рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░рдирд╛ рдкрдбрд╝ рд░рд╣рд╛ рд╣реИред",
        te: "р░Хр▒Нр░╖р░ор░┐р░Вр░Ър░Вр░бр░┐, р░Хр░╛р░ир▒А р░ир▒Зр░ир▒Б р░кр▒Нр░░р░╕р▒Нр░др▒Бр░др░В р░Хр▒Кр░ир▒Нр░ир░┐ р░╕р░╛р░Вр░Хр▒Зр░др░┐р░Х р░Зр░мр▒Нр░мр░Вр░жр▒Бр░▓р░ир▒Б р░Ор░жр▒Бр░░р▒Нр░Хр▒Кр░Вр░Яр▒Бр░ир▒Нр░ир░╛р░ир▒Бред",
        ta: "рооройрпНройро┐роХрпНроХро╡рпБроорпН, роЖройро╛ро▓рпН роиро╛ройрпН роЗрокрпНрокрпЛродрпБ роЪро┐ро▓ родрпКро┤ро┐ро▓рпНроирпБроЯрпНрок роЪро┐роХрпНроХро▓рпНроХро│рпИ роОродро┐ро░рпНроХрпКро│рпНроХро┐ро▒рпЗройрпН.",
        ml: "р┤Хр╡Нр┤╖р┤ор┤┐р┤Хр╡Нр┤Хр┤гр┤В, р┤кр┤Хр╡Нр┤╖р╡З р┤Ор┤ир┤┐р┤Хр╡Нр┤Хр╡Н р┤Зр┤кр╡Нр┤кр╡Лр╡╛ р┤Ър┤┐р┤▓ р┤╕р┤╛р┤Щр╡Нр┤Хр╡Зр┤др┤┐р┤Х р┤мр╡Бр┤жр╡Нр┤зр┤┐р┤ор╡Бр┤Яр╡Нр┤Яр╡Бр┤Хр╡╛ р┤ир╡Зр┤░р┤┐р┤Яр╡Бр┤ир╡Нр┤ир╡Бр┤гр╡Нр┤Яр╡Нред",
      }

      const finalErrorMessage: Message = {
        id: Date.now().toString(),
        role: "assistant",
        content: errorMessages[selectedLanguage] || errorMessages.en,
        timestamp: new Date().toISOString(),
        language: selectedLanguage,
      }
      
      setMessages((prev) => [...prev, finalErrorMessage])
      setIsTyping(false)
    } finally {
      setIsLoading(false)
    }
  }

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault()
      sendMessage()
    }
  }

  const copyMessage = (content: string) => {
    navigator.clipboard.writeText(content)
  }

  const exportChat = () => {
    const chatText = messages.map((msg) => `${msg.role.toUpperCase()}: ${msg.content}\n`).join("\n")

    const blob = new Blob([chatText], { type: "text/plain" })
    const url = URL.createObjectURL(blob)
    const a = document.createElement("a")
    a.href = url
    a.download = `tradegenie-chat-${new Date().toISOString().split("T")[0]}.txt`
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)
  }

  if (!user) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-beige-50 via-white to-purple-50 flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 bg-gradient-to-br from-purple-600 to-gold-500 rounded-lg flex items-center justify-center mx-auto mb-4">
            <Sparkles className="w-8 h-8 text-white animate-spin" />
          </div>
          <p className="text-gray-600">Loading chat...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-beige-50 via-white to-purple-50">
      {/* Header */}
      <header className="border-b border-purple-100 bg-white/80 backdrop-blur-sm sticky top-0 z-40">
        <div className="container mx-auto px-4 py-4 flex items-center justify-between">
          <div className="flex items-center space-x-4">
            <Link href="/dashboard">
              <Button variant="ghost" size="sm" className="text-purple-600">
                <ArrowLeft className="w-4 h-4 mr-2" />
                Dashboard
              </Button>
            </Link>

            <div className="flex items-center space-x-3">
              <div className="w-10 h-10 bg-gradient-to-br from-purple-600 to-gold-500 rounded-xl flex items-center justify-center">
                <Sparkles className="w-6 h-6 text-white" />
              </div>
              <div>
                <h1 className="text-2xl font-bold bg-gradient-to-r from-purple-600 to-gold-600 bg-clip-text text-transparent">
                  TradeGenie AI
                </h1>
                <p className="text-sm text-gray-500">Your intelligent trade assistant</p>
              </div>
            </div>
          </div>

          <div className="flex items-center space-x-3">
            {/* Language Selector */}
            <div className="flex items-center space-x-2">
              <Languages className="w-4 h-4 text-purple-600" />
              <Select
                value={selectedLanguage}
                onValueChange={(value: keyof typeof LANGUAGES) => setSelectedLanguage(value)}
              >
                <SelectTrigger className="w-32 bg-transparent border-purple-200">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {Object.entries(LANGUAGES).map(([code, lang]) => (
                    <SelectItem key={code} value={code}>
                      <span className="flex items-center space-x-2">
                        <span>{lang.flag}</span>
                        <span>{lang.name}</span>
                      </span>
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <Button variant="outline" size="sm" onClick={exportChat} className="bg-transparent">
              <Download className="w-4 h-4 mr-2" />
              Export Chat
            </Button>
            <Button variant="ghost" size="sm">
              <MoreVertical className="w-4 h-4" />
            </Button>
          </div>
        </div>
      </header>

      {/* Full Width Chat Area */}
      <div className="container mx-auto px-2 py-4 max-w-7xl">
        <Card className="border-purple-100 h-[calc(100vh-120px)] flex flex-col shadow-lg bg-white/70 backdrop-blur-sm">
          {/* Messages */}
          <div className="flex-1 overflow-y-auto p-6 space-y-4">
            <AnimatePresence>
              {messages.map((message) => (
                <motion.div
                  key={message.id}
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: -20 }}
                  className={`flex ${message.role === "user" ? "justify-end" : "justify-start"}`}
                >
                  <div
                    className={`flex max-w-[85%] ${
                      message.role === "user" ? "flex-row-reverse" : "flex-row"
                    } items-start space-x-4`}
                  >
                    <Avatar className="w-10 h-10 flex-shrink-0">
                      {message.role === "user" ? (
                        <>
                          <AvatarImage
                            src={`https://api.dicebear.com/7.x/initials/svg?seed=${user.firstName} ${user.lastName}`}
                          />
                          <AvatarFallback className="bg-gradient-to-br from-blue-500 to-purple-600">
                            <User className="w-5 h-5 text-white" />
                          </AvatarFallback>
                        </>
                      ) : (
                        <AvatarFallback className="bg-gradient-to-br from-purple-600 to-gold-500">
                          <Bot className="w-5 h-5 text-white" />
                        </AvatarFallback>
                      )}
                    </Avatar>

                    <div
                      className={`rounded-2xl p-5 ${
                        message.role === "user"
                          ? "bg-gradient-to-r from-purple-600 to-gold-600 text-white"
                          : "bg-gray-50 text-gray-800 border border-gray-100"
                      }`}
                    >
                      <div className="prose prose-sm max-w-none">
                        {message.content.split("\n").map((line, index) => (
                          <p
                            key={index}
                            className={`${message.role === "user" ? "text-white" : "text-gray-800"} ${index === 0 ? "mt-0" : ""}`}
                          >
                            {line}
                          </p>
                        ))}
                      </div>

                      <div className="flex items-center justify-between mt-4 pt-3 border-t border-opacity-20">
                        <div className="flex items-center space-x-2">
                          <span className={`text-xs ${message.role === "user" ? "text-white/70" : "text-gray-500"}`}>
                            {new Date(message.timestamp).toLocaleTimeString()}
                          </span>
                          {message.language && (
                            <Badge variant="outline" className="text-xs">
                              {LANGUAGES[message.language as keyof typeof LANGUAGES]?.flag}
                            </Badge>
                          )}
                        </div>
                        <Button
                          variant="ghost"
                          size="sm"
                          className={`h-7 w-7 p-0 ${
                            message.role === "user"
                              ? "text-white/70 hover:text-white hover:bg-white/10"
                              : "text-gray-400 hover:text-gray-600"
                          }`}
                          onClick={() => copyMessage(message.content)}
                        >
                          <Copy className="w-3 h-3" />
                        </Button>
                      </div>

                      {/* Intent Actions */}
                      {message.intents && (
                        <div className="mt-4 flex flex-wrap gap-2">
                          {message.intents.document?.detected && (
                            <Badge variant="secondary" className="text-xs">
                              <FileText className="w-3 h-3 mr-1" />
                              Document Intent
                            </Badge>
                          )}
                          {message.intents.partner?.detected && (
                            <Badge variant="secondary" className="text-xs">
                              <Users className="w-3 h-3 mr-1" />
                              Partner Search
                            </Badge>
                          )}
                          {message.intents.risk?.detected && (
                            <Badge variant="secondary" className="text-xs">
                              <Shield className="w-3 h-3 mr-1" />
                              Risk Analysis
                            </Badge>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                </motion.div>
              ))}
            </AnimatePresence>

            {/* Typing Indicator */}
            {isTyping && (
              <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="flex justify-start">
                <div className="flex items-start space-x-4">
                  <Avatar className="w-10 h-10">
                    <AvatarFallback className="bg-gradient-to-br from-purple-600 to-gold-500">
                      <Bot className="w-5 h-5 text-white" />
                    </AvatarFallback>
                  </Avatar>
                  <div className="bg-gray-50 rounded-2xl p-5 border border-gray-100">
                    <div className="flex space-x-1">
                      <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                      <div
                        className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"
                        style={{ animationDelay: "0.1s" }}
                      ></div>
                      <div
                        className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"
                        style={{ animationDelay: "0.2s" }}
                      ></div>
                    </div>
                  </div>
                </div>
              </motion.div>
            )}

            <div ref={messagesEndRef} />
          </div>

          {/* Input Area */}
          <div className="border-t border-purple-100 p-4 bg-white/50">
            <div className="flex items-center space-x-4">
              <div className="flex-1 relative">
                <Input
                  value={inputMessage}
                  onChange={(e) => setInputMessage(e.target.value)}
                  onKeyPress={handleKeyPress}
                  placeholder={PLACEHOLDERS[selectedLanguage]}
                  className="pr-12 border-purple-200 focus:border-purple-400 h-10 text-base rounded-xl"
                  disabled={isLoading}
                />
                <Button
                  variant="ghost"
                  size="sm"
                  className="absolute right-3 top-1/2 transform -translate-y-1/2 h-8 w-8 p-0 text-gray-400 hover:text-gray-600"
                >
                  <Mic className="w-4 h-4" />
                </Button>
              </div>
              <Button
                onClick={sendMessage}
                disabled={!inputMessage.trim() || isLoading}
                className="bg-gradient-to-r from-purple-600 to-gold-600 hover:from-purple-700 hover:to-gold-700 text-white h-10 px-6 rounded-xl"
              >
                <Send className="w-4 h-4" />
              </Button>
            </div>

            <p className="text-xs text-gray-500 mt-3 text-center">
              TradeGenie AI provides trade intelligence powered by comprehensive databases and AI. Always verify
              critical information.
            </p>
          </div>
        </Card>
      </div>
    </div>
  )
}
